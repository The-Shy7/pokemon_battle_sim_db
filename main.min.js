(function(){"use strict";let chosenpokemon="";let chosenopp="";let guid="";let automaticGameInterval=null;const SERVICE_URL="https://oxford.cs.washington.edu/cse154/pokedex-2/";const IMAGES_URL="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/";window.onload=function(){fetchPid();fillSprites();fetchUsers();fetchMyPokemon();yourPokedexMenuSetup();newGameMenuSetup();inviteMenuSetup();tradeMenuSetup();konamiSetup();$("main-menu-btn").onclick=function(){mainMenuView("your-pokedex-view");this.classList.add("hidden")};$("endgame").onclick=function(){mainMenuView("your-pokedex-view");this.classList.add("hidden")};$("restart-btn").onclick=function(){if(confirm("Are you sure you want to remove all Pokemon from your Pokedex and start with three new random Pokemon?")){getDex(pid,token,true);setTimeout(function(){fetchPlayerPokemon("my-dex-view",pid);resetCards()},1e3)}};toggleSubMenu("your-pokedex-btn","your-pokedex-view");let populateMyPokedexInitInterval=setInterval(function(){if(pid&&token&&myPokemon){clearInterval(populateMyPokedexInitInterval);fetchPlayerPokemon("my-dex-view",pid)}},100)};function mainMenuView(viewId="menu-view"){$("title").innerText="Game Menu";hide([$("game-view"),$("main-menu-btn")]);show([$(viewId),$("menu-view")]);let hps=document.querySelectorAll(".low-health");for(let i=0;i<hps.length;i++){hps[i].classList.remove("low-health")}let buffDivs=$$(".buffs");for(let i=0;i<buffDivs.length;i++){buffDivs[i].innerHTML=""}$("p1-turn-results").innerText="";$("p2-turn-results").innerText="";hide($("turn-status-p"));if(automaticGameInterval){clearInterval(automaticGameInterval);automaticGameInterval=null}}function yourPokedexMenuSetup(){$("your-pokedex-btn").onclick=pokedexView;$$("#your-pokedex-view-card .name").ondblclick=renamePokemon}function pokedexView(){toggleSubMenu(this.id,"your-pokedex-view");fetchPlayerPokemon("my-dex-view",pid)}function renamePokemon(){if(!chosenpokemon){return}if(window.getSelection){window.getSelection().removeAllRanges()}else if(document.selection){document.selection.empty()}let nickname=getNickname(chosenpokemon);let confmsg="Would you like to give "+chosenpokemon+" a nickname?";if(nickname){confmsg='Would you like to rename your "'+nickname+'"?'}if(confirm(confmsg)){nickname=prompt("Nickname to give your "+chosenpokemon+" (Leave empty to remove nickname):",nickname?nickname:"");if(nickname===null){return}}else{return}let message="Calling update.php with name="+chosenpokemon;let data=new FormData;data.append("name",chosenpokemon);if(nickname!=""){data.append("nickname",nickname);message+=" and nickname="+nickname}else{message+=" and no nickname"}console.log(message);postRequest("update.php",data,function(){let messageName=nickname!=""?nickname:chosenpokemon;alert("Success! You have renamed "+messageName+"!");fetchPlayerPokemon("pokedex-view",pid);fetchPlayerPokemon("my-pokemon",pid);fetchPlayerPokemon("my-dex-view",pid);let pokemonName=chosenpokemon+(nickname!=""?" ("+nickname+")":"");$$("#your-pokedex-view-card .name").innerText=pokemonName})}function newGameMenuSetup(){setUpOpponentButtons();$("new-game-btn").onclick=function(){toggleSubMenu(this.id,"new-game-view");if(!$("new-game-view").classList.contains("hidden")){resetNewGameView();$$("#new-game-view .part-0").classList.remove("hidden")}};$("choose-pokemon-btn").onclick=function(){fetchPlayerPokemon("pokedex-view",pid);toggleDisplay($$("#new-game-view .part-iii"));this.classList.toggle("chosen-btn")};$("start-game").onclick=function(){if(chosenpokemon!=""){if(chosenopp==""){chosenopp="-bot-"}$("choose-pokemon-title").innerText="Choose a Pokemon:";resetNewGameView();startGame(chosenopp)}}}function resetNewGameView(){let chosenBtns=$$("#new-game-view chosen-btn");for(let i=0;i<chosenBtns.length;i++){chosenBtns[i].classList.remove("chosen-btn")}hide([$$("#new-game-view .part-i"),$$("#new-game-view .part-ii"),$$("#new-game-view .part-iii")])}function showPokedexFromTrade(){if(chosenopp&&chosenopp!="-bot-"){hide($$("#new-game-view .part-iii hr"));$("choose-pokemon-title").innerText="Choose a Pokemon to play with "+chosenopp+":";fetchPlayerPokemon("pokedex-view",pid);show([$$("#new-game-view"),$$("#new-game-view .part-iii")]);hide($("invite-view"))}}function setUpOpponentButtons(){let opponentButtons=$$(".opponent-btn");for(let i=0;i<opponentButtons.length;i++){opponentButtons[i].onclick=function(){hide([$$("#new-game-view .part-ii"),$$("#new-game-view .part-iii")]);this.classList.toggle("chosen-btn");let chosensubbtns=$$("#new-game-view button");for(let j=0;j<chosensubbtns.length;j++){if(chosensubbtns[j]!=this){chosensubbtns[j].classList.remove("chosen-btn")}}for(let j=0;j<opponentButtons.length;j++){if(opponentButtons[j]!=this){if(this.classList.contains("chosen-btn")){opponentButtons[j].classList.remove("chosen-btn");if(this.id!="student"){hide($("choose-student"))}show($$("#new-game-view .part-ii"))}else{hide([$$("#new-game-view .part-ii")]);hide([$$("#new-game-view .part-iii")]);let chosensubbtns=$$("#new-game-view button");for(let k=0;k<chosensubbtns.length;k++){chosensubbtns[k].classList.remove("chosen-btn")}show(opponentButtons[j])}}}if(this.id=="student"){toggleDisplay($("choose-student"));if(!$("choose-student").classList.contains("hidden")){chosenopp="medskm"}}else{chosenopp=this.id}}}}function tradeMenuSetup(){$("trade-btn").onclick=function(){toggleSubMenu(this.id,"trade-view");hide($("current-proposals-view"));hide($("new-proposal-view"))};$("propose").onclick=function(){this.classList.toggle("chosen-btn");if(this.classList.contains("chosen-btn")){$("view-proposals").classList.remove("chosen-btn")}hide($("current-proposals-view"));toggleDisplay($("new-proposal-view"));if($("new-proposal-view").classList.contains("hidden")){show($("show-p2-dex"));hide($("pokedices"))}};$("propose-submit").onclick=proposeTrade;$("view-proposals").onclick=function(){toggleDisplay($("current-proposals-view"));this.classList.toggle("chosen-btn");hide($("new-proposal-view"));if(this.classList.contains("chosen-btn")){$("propose").classList.remove("chosen-btn");fetchProposals()}};$("show-p2-dex").onclick=function(){show([$$("#new-proposal-view .part-iv"),$("pokedices")]);this.classList.add("hidden");fetchPlayerPokemon("my-pokemon",pid);fetchPlayerPokemon("their-pokemon",$("users").value)};$("users").onchange=function(){fetchPlayerPokemon("my-pokemon",pid);fetchPlayerPokemon("their-pokemon",$("users").value)}}function inviteMenuSetup(){$("invite-btn").onclick=function(){fetchInvites()}}function konamiSetup(){const ALLOWED_KEYS={37:"left",38:"up",39:"right",40:"down",65:"a",66:"b"};const KONAMI_CODE=["up","up","down","down","left","right","left","right","b","a"];let konamiCodePosition=0;document.addEventListener("keydown",function(e){let key=ALLOWED_KEYS[e.keyCode];let requiredKey=KONAMI_CODE[konamiCodePosition];if(key==requiredKey){konamiCodePosition++;if(konamiCodePosition==KONAMI_CODE.length){activateKonamiCheats();konamiCodePosition=0}}else{konamiCodePosition=0}})}function activateKonamiCheats(){alert("Welcome PonyTA.");(function(srcs,cfg){var cbcount=1;var callback=function(){--cbcount;if(cbcount===0){BrowserPonies.setBaseUrl(cfg.baseurl);if(!BrowserPoniesBaseConfig.loaded){BrowserPonies.loadConfig(BrowserPoniesBaseConfig);BrowserPoniesBaseConfig.loaded=true}BrowserPonies.loadConfig(cfg);if(!BrowserPonies.running())BrowserPonies.start()}};if(typeof BrowserPoniesConfig==="undefined"){window.BrowserPoniesConfig={}}if(typeof BrowserPoniesBaseConfig==="undefined"){++cbcount;BrowserPoniesConfig.onbasecfg=callback}if(typeof BrowserPonies==="undefined"){++cbcount;BrowserPoniesConfig.oninit=callback}var node=document.body||document.documentElement||document.getElementsByTagName("head")[0];for(var id in srcs){if(document.getElementById(id))continue;if(node){var s=document.createElement("script");s.type="text/javascript";s.id=id;s.src=srcs[id];node.appendChild(s)}else{document.write('<script type="text/javscript" src="'+srcs[id]+'" id="'+id+'"><\/script>')}}callback()})({"browser-ponies-script":"https://panzi.github.io/Browser-Ponies/browserponies.js","browser-ponies-config":"https://panzi.github.io/Browser-Ponies/basecfg.js"},{baseurl:"https://panzi.github.io/Browser-Ponies/",fadeDuration:500,volume:1,fps:25,speed:3,audioEnabled:false,dontSpeak:true,showFps:false,showLoadProgress:true,speakProbability:.1,spawn:{"rainbow dash":1}});void 0;document.body.style.background="-webkit-linear-gradient(top, #2d96c6 0%,#c9e6f4 100%)";document.body.style.height="100vh";$("title").innerText="PonyTA MODE ACTIVE!"}function fetchInvites(){getRequest(SERVICE_URL+"list-games.php",creds(),populateInvites)}function fetchPlayerPokemon(dexId,playerid){let myDex=playerid===pid;getRequest(SERVICE_URL+"users.php","?mode=pokemon&pid="+playerid,function(responseText){let json=JSON.parse(responseText);showSprites(dexId,json);if(myDex){fetchMyPokemon()}})}function fetchProposals(){let url=SERVICE_URL+"list-trades.php";getRequest(url,creds(),displayProposals)}function fetchTradeData(id,table){getRequest(SERVICE_URL+"trade-info.php",creds()+"&trade_id="+id,function(responseText){let result=JSON.parse(responseText);makeRow(result,table)})}function fetchUsers(){getRequest(SERVICE_URL+"list-users.php","",populateUsers)}function displayProposals(responseText){let json=JSON.parse(responseText);if(json["offers_from_me"].length===0&&json["offers_to_me"].length===0){$("trade-message").innerHTML="There are no trades currently offered to you.";hide([$("by-you"),$("to-you")]);show($("trade-message"))}else{populateTable(json)}}function populateTable(json){let head1="<tr><th>Player</th><th>Your Offer</th><th>Your Request</th><th>Date</th></tr>";let head2="<tr><th>Player</th><th>Their Offer</th><th>Their Request</th><th>Date</th></tr>";let toMe=json["offers_to_me"];if(toMe.length>0){$$("#to-you .results-table").innerHTML=head2}else{$$("#to-you .results-table").innerHTML="<p>You do not have any proposals to accept or decline.</p>"}for(let i=0;i<toMe.length;i++){let id=toMe[i];fetchTradeData(id,"to-you")}let fromMe=json["offers_from_me"];if(fromMe.length>0){$$("#by-you .results-table").innerHTML=head1}else{$$("#by-you .results-table").innerHTML="<p>You do not have any proposals waiting to be accepted or declined by other players.</p>"}for(let i=0;i<fromMe.length;i++){let id=fromMe[i];fetchTradeData(id,"by-you")}hide($("trade-message"));show([$("by-you"),$("to-you"),$$("#by-you .results-table"),$$("#to-you .results-table")])}function populateUsers(responseText){let users=JSON.parse(responseText);let dropdown=$("users");for(let i=0;i<users.length;i++){if(users[i]!=pid){let opt=document.createElement("option");opt.value=users[i];opt.innerText=users[i];dropdown.appendChild(opt);let oppopt=document.createElement("option");oppopt.value=users[i];oppopt.innerText=users[i];$("opps").appendChild(oppopt)}}$("opps").value="medskm";$("users").value="medskm";$("opps").onchange=function(){chosenopp=this.value;show($("choose-pokemon-btn"));show($("start-game"))}}function makeRow(result,table){let tr=gen("tr");tr.id=result.id;let playerName=table==="to-you"?result.offerer:result.offeree;let p2=genText("td",playerName);let want=gen("td");let pwant=genText("p",result.requested_pokemon);let poffer=genText("p",result.offered_pokemon);let wantimg=$$("#pokedex-view .sprite[pokemon='"+result.requested_pokemon+"']").cloneNode();want.appendChild(pwant);pwant.appendChild(wantimg);let offer=gen("td");let offerimg=$$("#pokedex-view .sprite[pokemon='"+result.offered_pokemon+"']").cloneNode();if(table==="to-you"){wantimg.classList.remove("unfound")}else{offerimg.classList.remove("unfound")}offer.appendChild(poffer);poffer.appendChild(offerimg);let time=genText("td",result.created);let action=gen("td");appendChildren(tr,[p2,offer,want,time]);if(table=="to-you"){let accept=gen("button","small-btn");accept.innerText="Accept";accept.onclick=acceptTrade;let reject=gen("button","small-btn");reject.innerText="Reject";reject.onclick=cancelTrade;appendChildren(action,[accept,reject])}else{let cancel=gen("button","small-btn");cancel.innerText="Cancel Request";action.appendChild(cancel);cancel.onclick=cancelTrade}tr.appendChild(action);$$("#"+table+" .results-table tbody").appendChild(tr)}function acceptTrade(){if(confirm("Are you sure you want to accept this trade?")){let tradeid=this.parentNode.parentNode.id;let params=new FormData;params.append("pid",pid);params.append("token",token);params.append("action","accept");let toGive=this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim();let toGet=this.parentNode.parentNode.querySelectorAll("td")[1].innerText.trim();params.append("pokemon",toGive);params.append("trade_id",tradeid);postRequest(SERVICE_URL+"conclude-trade.php",params,function(){alert("Trade successful!");executeLocalTrade(toGive,toGet);let nickname="";if(confirm("You've collected "+toGet+" from a trade! Give it a nickname?")){nickname=prompt("Nickname to give your "+toGet+":")}if(nickname){updateNickname(toGet,nickname)}fetchProposals()})}}function executeLocalTrade(toGive,toGet){console.log("Calling student's trade.php with mypokemon="+toGive+" and theirpokemon="+toGet+"...");let params=new FormData;params.append("mypokemon",toGive);params.append("theirpokemon",toGet);postRequest("trade.php",params,logStudentTestCall)}function updateNickname(pokemon,nickname){let params=new FormData;params.append("name",pokemon);params.append("nickname",nickname);console.log("Calling student's update.php with name="+name+" and nickname="+nickname+"...");postRequest("update.php",params,logStudentTestCall)}function cancelTrade(){if(confirm("Are you sure you want to cancel this trade?")){let tradeid=this.parentNode.parentNode.id;let params=new FormData;params.append("pid",pid);params.append("token",token);params.append("pokemon",this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim());params.append("tradeid",tradeid);postRequest(SERVICE_URL+"cancel-trade.php",params,function(){alert("Trade successfully canceled");fetchProposals()})}}function proposeTrade(){let offer=$("offer").innerText;let request=$("request").innerText;if(offer!=""&&request!=""){let params=new FormData;params.append("pid",pid);params.append("pid2",$("users").value);params.append("token",token);params.append("pokemon",offer);params.append("pokemon2",request);postRequest(SERVICE_URL+"offer-trade.php",params,function(){alert("Proposal successful!");$("view-proposals").click()})}else{alert("Please select a Pokemon to offer and request from the displayed Pokedex views.")}}function showSprites(dexId,response){let dex=$(dexId);resetSprites(dexId);for(let i=0;i<response.length;i++){let sprite=dex.querySelector("img[pokemon='"+escSpChar(response[i])+"']");if(sprite){sprite.classList.remove("unfound");if(dexId=="pokedex-view"){sprite.onclick=searchForPokemon}else{sprite.onclick=choosePokemon}}}}function resetSprites(dexId){let allSprites=$(dexId).querySelectorAll(".sprite");for(let i=0;i<allSprites.length;i++){allSprites[i].classList.add("unfound");allSprites[i].onclick=""}}function choosePokemon(){if(this.parentNode.parentNode.querySelector("h2 span")){this.parentNode.parentNode.querySelector("h2 span").innerText=this.getAttribute("pokemon")}else{chosenpokemon=this.getAttribute("pokemon");searchForPokemon.call(this)}}function fillSprites(){getRequest(SERVICE_URL+"pokedex.php","?pokedex=all",populateDexes)}function populateInvites(responseText){let result=JSON.parse(responseText);if(result.offered_by_me||result.offered_to_me||result.in_progress){let head="<tr><th>Other Player</th></tr>";$("games-table").innerHTML=head;if(result.offered_by_me){populateInvitesTable("Pending","cancel",result.offered_by_me)}if(result.offered_to_me){populateInvitesTable("Pending","accept",result.offered_to_me)}if(result.in_progress){populateInvitesTable("current","join",result.in_progress)}}else{$$("#invite-results h3").innerHTML="You currently have no games in progress or pending."}toggleSubMenu("invite-btn","invite-view")}function populateDexes(responseText){let pokeData=responseText.split("\n");for(let i=0;i<pokeData.length;i++){let parts=pokeData[i].split(":");let name=parts[0];let imgname=parts[1];let img=gen("img",["sprite","unfound"]);img.src=IMAGES_URL+"sprites/"+imgname;img.setAttribute("pokemon",name);$("my-pokemon").appendChild(img);$("their-pokemon").appendChild(img.cloneNode());$("pokedex-view").appendChild(img.cloneNode());$("my-dex-view").appendChild(img.cloneNode())}}function populateInvitesTable(state,action,results){for(let i=0;i<results.length;i++){let inviteguid=results[i][0];let otherplayerpid=results[i][1];if(otherplayerpid==pid){otherplayerpid=results[i][2]}if(!otherplayerpid){otherplayerpid="-bot-"}let otherplayertd=genText("td",otherplayerpid);let actiontd=gen("td");let actionBtn=gen("button",["small-btn"]);if(action=="accept"){actionBtn.innerText="Accept Invite";actionBtn.onclick=function(){chosenopp=this.parentNode.parentNode.querySelector("td").innerText;hide($("opponent-btns"));hide($("choose-student"));hide($$("#new-game-view .part-ii"));showPokedexFromTrade()};actiontd.appendChild(actionBtn)}else if(action=="join"){actionBtn.innerText="Continue Game";actiontd.appendChild(actionBtn);actionBtn.onclick=function(){continueGame(this.parentNode.parentNode.id)}}else if(action=="cancel"){let stat=genText("span","Invite Pending");actiontd.appendChild(stat)}let tr=gen("tr");tr.id=inviteguid;appendChildren(tr,[otherplayertd,actiontd]);$("games-table").appendChild(tr)}show($("games-table"))}function resetDex(dexId){let sprites=$(dexId).querySelectorAll(".sprite");for(let i=0;i<sprites.length;i++){sprites[i].classList.add("unfound");sprites[i].removeEventListener("onclick",choosePokemon)}}function gameView(json){let result=json;console.log(result);if(result.warning){console.log(result.warning)}else{populateCards(result);guid=result.guid;$("title").innerText="Pokemon Battle Mode!";clearSelectedButtons();closeAllSubMenus();hide([$("menu-view")]);show([$("game-view"),$("main-menu-btn"),$("results-container")])}}function startGame(opponent){if(chosenpokemon==""){alert("Please select a Pokemon to start a game with.")}else{let params=new FormData;params.append("opponent",opponent);params.append("mypokemon",chosenpokemon);params.append("pid",pid);params.append("token",token);postRequest(SERVICE_URL+"create-game.php",params,function(responseText){if(opponent=="-bot-"||getCurrentView().id=="invite-view"){gameView(JSON.parse(responseText));if(!automaticGameInterval){automaticGameInterval=setInterval(continueGame,1e4,JSON.parse(responseText).guid)}}else{alert("Game invite sent successfully!");fetchInvites()}})}}function continueGame(gameid){guid=gameid;console.log("Updating current player game info.");getRequest(SERVICE_URL+"game-info.php",creds()+"&guid="+gameid,function(responseText){gameView(JSON.parse(responseText))});if(!automaticGameInterval){automaticGameInterval=setInterval(continueGame,1e4,gameid)}}function resetCards(){let cards=["chosen-card","your-pokedex-view-card"];let defaultData={name:"Pokemon Name",hp:60,info:{type:"fire",weakness:"water",description:"Description here."},images:{photo:"images/pokeball.png",typeIcon:"icons/fighting.jpg",weaknessIcon:"icons/fighting.jpg"},moves:[{name:"Move Name Here",dp:"",type:"fighting"},{name:"Move Name Here",dp:"",type:"fighting"},{name:"Move Name Here",dp:"",type:"fighting"},{name:"Move Name Here",dp:"",type:"fighting"}]};chosenpokemon=null;for(let i=0;i<cards.length;i++){display(cards[i],defaultData)}}function display(cardid,pokeData){cardid="#"+cardid;$$(cardid+" .name").innerText=pokeData["name"];$$(cardid+" .pokepic").src=IMAGES_URL+pokeData["images"]["photo"];$$(cardid+" .weakness").src=IMAGES_URL+pokeData["images"]["weaknessIcon"];$$(cardid+" .type").src=IMAGES_URL+pokeData["images"]["typeIcon"];$$(cardid+" .info").innerText=pokeData["info"]["description"];$$(cardid+" .hp").innerText=pokeData["hp"]+"HP";let moveset=pokeData["moves"];let moves=$$(cardid+" .moves button");let i=0;for(;i<moveset.length;i++){let move=moveset[i]["name"];let button=moves[i];if(button.classList.contains("hidden")){button.classList.remove("hidden")}let moveSpan=button.children[0];moveSpan.innerText=moveset[i]["name"];let img=button.children[2];img.src=IMAGES_URL+"icons/"+moveset[i]["type"]+".jpg";let dpSpan=button.children[1];if(moveset[i]["dp"]){dpSpan.innerText=moveset[i]["dp"]+" DP"}else{dpSpan.innerText=""}if(cardid==="#my-card"){button.disabled=false;button.onclick=function(){playMove(this.children[0].innerText)}}}if(cardid==="#chosen-card"||cardid==="#my-card"||cardid==="#your-pokedex-view-card"){let nick=pokeData["name"]?getNickname(pokeData["name"]):"";if(nick){$$(cardid+" h2.name").innerText=pokeData["name"]+" ("+nick+")"}}while(i<4){moves[i].classList.add("hidden");i++}}function playMove(moveName){$("p1-turn-results").innerHTML="";$("p2-turn-results").innerHTML="";show($("loading"));moveName=moveName.toLowerCase();let params=new FormData;params.append("move",moveName);params.append("guid",guid);params.append("pid",pid);params.append("token",token);let xhr=new XMLHttpRequest;xhr.onreadystatechange=function(e){if(xhr.readyState===4){if(xhr.status===200){updateCards(JSON.parse(this.responseText))}else if(xhr.status===201){let warning=JSON.parse(xhr.statusText).warning;console.log(warning);$("turn-status").innerText="It's not your turn!";show($("turn-status-p"));hide($("loading"))}}};xhr.open("POST",SERVICE_URL+"move.php");xhr.send(params)}function searchForPokemon(){if($("start-game").classList.contains("hidden")){$("start-game").classList.remove("hidden")}let pname=this.getAttribute("pokemon");if(pname!=""){chosenpokemon=pname;getRequest(SERVICE_URL+"pokedex.php","?pokemon="+pname,function(responseText){let data=JSON.parse(responseText);display("chosen-card",data);display("my-card",data);display("your-pokedex-view-card",data)})}}function populateCards(result){let pid1=result["pid1"];let pid2=result["pid2"];let theirPid=pid1==pid?pid2:pid1;let myPlayerNumber=result["players"][pid];let theirPlayerNumber=result["players"][theirPid];let myData=result[myPlayerNumber];let theirData=result[theirPlayerNumber];if(theirPid!="-bot-"){if(myPlayerNumber==result["turn"]){$("turn-status").innerText="It's your turn!";$("turn-status").classList.add("your-turn")}else{$("turn-status").innerText="Waiting for "+theirPid+" to make a move...";$("turn-status").classList.remove("your-turn")}show($("turn-status-p"))}display("my-card",myData);display("their-card",theirData);updateCard("my-card",myData);updateCard("their-card",theirData)}function updateCards(result){let pid1=result["pid1"];let pid2=result["pid2"];let theirPid=pid1==pid?pid2:pid1;let myPlayerNumber=result["players"][pid];let theirPlayerNumber=result["players"][theirPid];let myData=result[myPlayerNumber];let theirData=result[theirPlayerNumber];if(theirPid!="-bot-"){if(myPlayerNumber==result["turn"]){$("turn-status").innerText="It's your turn!";$("turn-status").classList.add("your-turn")}else{$("turn-status").innerText="Waiting for "+theirPid+" to make a move...";$("turn-status").classList.remove("your-turn")}show($("turn-status-p"))}else{theirPid=theirData.name}updateCard("my-card",myData);updateCard("their-card",theirData);let results=result.results;let p1Results=results["p1-result"];let p2Results=results["p2-result"];let iamp1=myPlayerNumber=="p1";if(result["turn"]!=""){if(p2Results){let p2Name=iamp1?theirPid:"You";if(p2Results.startsWith("miss")){p2Results="missed"}if(result["turn"]=="p2"){$("p1-turn-results").innerText=p2Name+" played "+results["p2-move"]+" and "+p2Results+"!"}else{$("p2-turn-results").innerText=p2Name+" played "+results["p2-move"]+" and "+p2Results+"!"}}if(p1Results){if(p1Results.startsWith("miss")){p1Results="missed"}let p1Name=iamp1?"You":theirPid;if(result["turn"]=="p2"){$("p2-turn-results").innerText=p1Name+" played "+results["p1-move"]+" and "+p1Results+"!"}else{$("p1-turn-results").innerText=p1Name+" played "+results["p1-move"]+" and "+p1Results+"!"}}}else{let youWon=theirData["current-hp"]==0;if(youWon){let yourMove=iamp1?results["p1-move"]:results["p2-move"];let yourResult=iamp1?p1Results:p2Results;$("p1-turn-results").innerHTML="You played "+yourMove+" and "+yourResult+"!"}else{let theirMove=iamp1?results["p2-move"]:results["p1-move"];let theirResult=iamp1?p2Results:p1Results;$("p1-turn-results").innerHTML=theirPid+" played "+theirMove+" and "+theirResult+"!"}}hide($("loading"));show([$("p1-turn-results"),$("p2-turn-results")])}function updateCard(cardid,result){if(!result["error"]){let card=$(cardid);card.querySelector(".hp").innerText=result["current-hp"]+"HP";card.querySelector(".buffs").innerHTML="";populateBuffs($$("#"+cardid+" .buffs"),result["buffs"],result["debuffs"]);let hpLeft=result["current-hp"]*1/result["hp"];card.querySelector(".health-bar").style.width=100*hpLeft+"%";if(hpLeft<=.2){card.querySelector(".health-bar").classList.add("low-health")}if(cardid=="my-card"){if(hpLeft==0){endGame(false)}}else if(cardid=="their-card"){if(hpLeft==0){endGame(true);let imgname=result["images"]["photo"];let id=result["name"];let sprite=$("my-pokemon").querySelector(".sprite[pokemon="+escSpChar(id)+"]");if(sprite&&sprite.classList.contains("unfound")){addToPokedex(id)}}}}hide($("loading"))}function populateBuffs(buffsDiv,buffs,debuffs){for(let i=0;i<buffs.length+debuffs.length;i++){let buffType=i<buffs.length?buffs[i]:debuffs[i];let div=document.createElement("div");div.className=i<buffs.length?"buff":"debuff";div.classList.add(buffType);buffsDiv.appendChild(div)}return buffsDiv}function endGame(results){resetCards();let moves=$("my-card").querySelectorAll(".moves button");hide($("turn-status-p"));for(let i=0;i<moves.length;i++){moves[i].disabled=true}$("title").innerText="You "+(results?"won!":"lost!");show([$("results-container"),$("endgame")]);if(automaticGameInterval){clearInterval(automaticGameInterval);automaticGameInterval=null}}function addToPokedex(pokemon){let nickname="";if(confirm("You've collected "+pokemon+"! Give it a nickname?")){nickname=prompt("Nickname to give your "+pokemon+":")}if(nickname===null){nickname=""}let message="Calling insert.php with name="+pokemon;let data=new FormData;data.append("name",pokemon);if(nickname!=""){data.append("nickname",nickname);message+=" and nickname="+nickname}else{message+=" and no nickname"}console.log(message);postRequest("insert.php",data,function(){let messageName=nickname!=""?nickname:pokemon;alert("Success! You have added "+messageName+" to your Pokedex!");fetchPlayerPokemon("pokedex-view",pid);fetchPlayerPokemon("my-pokemon",pid);fetchPlayerPokemon("my-dex-view",pid)})}function clearSelectedButtons(){let selected=$$(".opponent-btn");for(let i=0;i<selected.length;i++){selected[i].classList.remove("chosen-btn");selected[i].classList.remove("hidden")}selected=$$(".menu-btn");for(let i=0;i<selected.length;i++){selected[i].classList.remove("chosen-btn")}}function closeAllSubMenus(){let currentView=getCurrentView();if(currentView){currentView.classList.remove(".current-view")}let submenus=document.querySelectorAll(".sub-menu");for(let i=0;i<submenus.length;i++){hide(submenus[i])}}function toggleSubMenu(clickedbtn,submenu){hide($$("#new-game-view .part-iii"));if($(clickedbtn).classList.contains("chosen-btn")){$(clickedbtn).classList.remove("chosen-btn");closeAllSubMenus()}else{let submenus=document.querySelectorAll(".sub-menu");let menubtns=document.querySelectorAll(".chosen-btn");for(let i=0;i<menubtns.length;i++){if(menubtns[i]!=clickedbtn){menubtns[i].classList.remove("chosen-btn")}}$(clickedbtn).classList.add("chosen-btn");if($(submenu).classList.contains("hidden")){for(let i=0;i<submenus.length;i++){if(submenus[i]!=$(submenu)){hide(submenus[i]);submenus[i].classList.remove("current-view")}else{show(submenus[i]);submenus[i].classList.add("current-view");if(submenu==="trade-view"){hide($("new-proposal-view"));hide($("current-proposals-view"))}}}}}}function getNickname(name){name=name.toLowerCase();let poke=myPokemon["pokemon"];for(let i=0;i<poke.length;i++){let localName=poke[i]["name"].toLowerCase();if(localName==name&&localName.toUpperCase()!=poke[i]["nickname"]){return poke[i]["nickname"]}}return null}function getCurrentView(){return document.querySelector(".current-view")}})();
